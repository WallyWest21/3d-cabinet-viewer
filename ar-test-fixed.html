<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Test - 3D Cabinet Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        
        .requirements {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }
        
        .test-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        
        .test-button:hover {
            background: #45a049;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        model-viewer {
            width: 100%;
            height: 400px;
            background-color: #f0f0f0;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>AR Functionality Test</h1>
        
        <div class="info-box">
            <h3>About AR Support</h3>
            <p>This page tests the AR functionality of your 3D cabinet viewer. AR (Augmented Reality) allows you to place and view the cabinet in your real-world space using your device's camera.</p>
        </div>
        
        <div class="requirements">
            <h3>Requirements for AR to Work:</h3>
            <ul>
                <li><strong>Device:</strong> iPhone/iPad (iOS 12+) or Android device with ARCore support</li>
                <li><strong>Browser:</strong> Safari on iOS, Chrome on Android</li>
                <li><strong>Security:</strong> HTTPS connection (required for camera access)</li>
                <li><strong>Permissions:</strong> Camera access permission when prompted</li>
            </ul>
        </div>
        
        <button class="test-button" onclick="testARSupport()">Test AR Support</button>
        <button class="test-button" onclick="loadTestModel()" disabled id="load-btn">Load Test Cabinet Model</button>
        <button class="test-button" onclick="loadGoogleModel()" style="background: #2196f3;">Load Google Test Model (Reliable)</button>
        <button class="test-button" onclick="manualARActivation()" style="background: #9c27b0;" id="manual-ar-btn" disabled>üöÄ Manual AR Activation</button>
        
        <div id="status-messages"></div>
        
        <model-viewer
            id="ar-test-viewer"
            ar
            ar-modes="webxr scene-viewer quick-look"
            ar-scale="auto"
            ar-placement="floor"
            camera-controls
            touch-action="pan-y"
            shadow-intensity="0.5"
            environment-image="neutral"
            exposure="1.0"
            tone-mapping="neutral"
            loading="eager"
            reveal="auto"
            seamless-poster
            poster=""
            alt="Test Cabinet for AR">
            <div slot="ar-button">
                <button id="custom-ar-button" style="background: #ff6b35; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px;" onclick="debugARButton()">
                    üì± View in Your Space
                </button>
            </div>
            <div slot="poster">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #666;">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                        <div>Load a model to test AR</div>
                    </div>
                </div>
            </div>
        </model-viewer>
        
        <div class="info-box">
            <h3>How to Test:</h3>
            <ol>
                <li>Click "Test AR Support" to check if your device supports AR</li>
                <li>Click "Load Test Cabinet Model" or "Load Google Test Model"</li>
                <li>Click "üì± View in Your Space" to launch AR mode</li>
                <li>If that doesn't work, try "üöÄ Manual AR Activation"</li>
                <li>Grant camera permissions when prompted</li>
                <li>Move your device to scan the floor/surface</li>
                <li>Tap to place the cabinet in your space</li>
            </ol>
        </div>
        
        <div class="info-box">
            <h3>Troubleshooting AR Issues:</h3>
            <ul>
                <li><strong>Nothing happens when clicking AR:</strong> Try the "Manual AR Activation" button</li>
                <li><strong>App crashes during AR:</strong> Try the "Google Test Model" first - it's more stable</li>
                <li><strong>Returns to main page:</strong> Your device may be low on memory - close other apps</li>
                <li><strong>AR button doesn't appear:</strong> Ensure HTTPS and compatible device/browser</li>
                <li><strong>Camera doesn't start:</strong> Check Chrome permissions: Settings ‚Üí Site Settings ‚Üí Camera</li>
                <li><strong>Surface detection fails:</strong> Ensure good lighting and move device slowly over textured surfaces</li>
                <li><strong>iOS users:</strong> Look for "AR" icon in Safari address bar as alternative entry point</li>
                <li><strong>Persistent crashes:</strong> Try refreshing the page and testing with smaller models first</li>
            </ul>
            
            <h4 style="color: #ff9800;">If AR keeps failing:</h4>
            <ol>
                <li>Test with "Google Test Model" first (more stable)</li>
                <li>Close other apps to free memory</li>
                <li>Ensure strong WiFi connection</li>
                <li>Try in an incognito/private browser window</li>
                <li>Restart your browser completely</li>
                <li>Check browser console for error messages</li>
            </ol>
        </div>
    </div>

    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script>
        function addStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-messages');
            const statusElement = document.createElement('div');
            statusElement.className = `status ${type}`;
            statusElement.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusDiv.appendChild(statusElement);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        function testARSupport() {
            addStatus('Testing AR support...', 'info');
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Check basic requirements
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addStatus('‚ùå Camera API not available (HTTPS required)', 'error');
                return;
            }
            
            // Check if model-viewer supports AR
            if (typeof modelViewer.canActivateAR !== 'undefined') {
                if (modelViewer.canActivateAR) {
                    addStatus('‚úÖ AR is supported on this device!', 'success');
                    document.getElementById('load-btn').disabled = false;
                } else {
                    addStatus('‚ùå AR is not supported on this device/browser', 'error');
                }
            } else {
                addStatus('‚è≥ AR support detection not ready yet. Try loading a model first.', 'info');
                document.getElementById('load-btn').disabled = false;
            }
            
            // Check device type
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isIOS) {
                addStatus('üì± iOS device detected - AR should work in Safari', 'success');
            } else if (isAndroid) {
                addStatus('ü§ñ Android device detected - AR should work in Chrome with ARCore', 'success');
            } else {
                addStatus('üíª Desktop detected - AR not available on desktop browsers', 'info');
            }
            
            // Check HTTPS
            if (location.protocol === 'https:') {
                addStatus('üîí HTTPS connection confirmed', 'success');
            } else {
                addStatus('‚ö†Ô∏è HTTP connection - AR may not work without HTTPS', 'error');
            }
        }
        
        function debugARButton() {
            addStatus('üîç AR button clicked - checking status...', 'info');
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Check if model is loaded
            if (!modelViewer.src) {
                addStatus('‚ùå No model loaded - load a model first!', 'error');
                return;
            }
            
            // Check AR support
            console.log('Model viewer canActivateAR:', modelViewer.canActivateAR);
            console.log('AR modes:', modelViewer.arModes);
            console.log('Current src:', modelViewer.src);
            
            if (!modelViewer.canActivateAR) {
                addStatus('‚ùå AR not available - device/browser may not support AR', 'error');
                
                // Try to force AR activation anyway
                addStatus('üîÑ Attempting to force AR activation...', 'info');
                try {
                    modelViewer.activateAR();
                } catch (error) {
                    addStatus('‚ùå Force activation failed: ' + error.message, 'error');
                }
                return;
            }
            
            // Try to activate AR
            addStatus('üöÄ Attempting to start AR session...', 'info');
            try {
                modelViewer.activateAR().then(() => {
                    addStatus('‚úÖ AR activation successful!', 'success');
                }).catch((error) => {
                    addStatus('‚ùå AR activation failed: ' + error.message, 'error');
                    console.error('AR activation error:', error);
                });
            } catch (error) {
                addStatus('‚ùå AR activation error: ' + error.message, 'error');
                console.error('AR activation error:', error);
            }
        }
        
        async function manualARActivation() {
            addStatus('üöÄ Manual AR activation triggered...', 'info');
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            if (!modelViewer.src) {
                addStatus('‚ùå Load a model first!', 'error');
                return;
            }
            
            try {
                // Multiple activation attempts
                addStatus('üîÑ Attempt 1: Direct AR activation...', 'info');
                await modelViewer.activateAR();
                addStatus('‚úÖ AR activated successfully!', 'success');
                
            } catch (error1) {
                addStatus('‚ö†Ô∏è Attempt 1 failed: ' + error1.message, 'error');
                
                try {
                    addStatus('üîÑ Attempt 2: Checking WebXR support...', 'info');
                    
                    if ('xr' in navigator) {
                        const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
                        if (isSupported) {
                            addStatus('‚úÖ WebXR AR is supported!', 'success');
                            await modelViewer.activateAR();
                        } else {
                            addStatus('‚ùå WebXR AR not supported', 'error');
                        }
                    } else {
                        addStatus('‚ùå WebXR not available', 'error');
                    }
                    
                } catch (error2) {
                    addStatus('‚ùå All activation attempts failed', 'error');
                    addStatus('üí° Try using Chrome on Android or Safari on iOS', 'info');
                    console.error('Manual AR activation failed:', error2);
                }
            }
        }
        
        async function loadTestModel() {
            addStatus('Creating test cabinet model...', 'info');
            
            try {
                // Use a simpler, more reliable approach for AR testing
                await createSimpleCabinet();
                
            } catch (error) {
                console.error('Model creation error:', error);
                addStatus('‚ùå Failed to create test model: ' + error.message, 'error');
                
                // Fallback: use a hosted test model
                addStatus('üîÑ Using fallback model...', 'info');
                await loadFallbackModel();
            }
        }
        
        async function createSimpleCabinet() {
            // Create a very simple, AR-optimized cabinet model
            const scene = new THREE.Scene();
            
            // Use smaller, AR-appropriate dimensions (in meters)
            const width = 0.5;   // 50cm width
            const height = 0.7;  // 70cm height  
            const depth = 0.3;   // 30cm depth
            
            // Main cabinet body - single mesh for better performance
            const cabinetGeometry = new THREE.BoxGeometry(width, height, depth);
            const cabinetMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xD2B48C, // Tan wood color
                roughness: 0.7,
                metalness: 0.0,
                // Optimize for AR
                transparent: false,
                alphaTest: 0.5
            });
            
            const cabinet = new THREE.Mesh(cabinetGeometry, cabinetMaterial);
            cabinet.position.set(0, height/2, 0); // Position on floor
            cabinet.castShadow = true;
            cabinet.receiveShadow = true;
            scene.add(cabinet);
            
            // Simple door panel
            const doorGeometry = new THREE.BoxGeometry(width - 0.05, height - 0.05, 0.02);
            const door = new THREE.Mesh(doorGeometry, cabinetMaterial.clone());
            door.position.set(0, height/2, depth/2 + 0.01);
            scene.add(door);
            
            // Small handle
            const handleGeometry = new THREE.BoxGeometry(0.02, 0.08, 0.03);
            const handleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                metalness: 0.7,
                roughness: 0.3
            });
            const handle = new THREE.Mesh(handleGeometry, handleMaterial);
            handle.position.set(width/2 - 0.08, height/2, depth/2 + 0.025);
            scene.add(handle);
            
            // Add basic lighting to the scene
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            addStatus('üîß Exporting optimized GLB model...', 'info');
            
            // Export with optimized settings for AR
            const exporter = new THREE.GLTFExporter();
            const gltf = await new Promise((resolve, reject) => {
                exporter.parse(scene, 
                    (result) => resolve(result),
                    {
                        binary: true,
                        embedImages: true,
                        maxTextureSize: 512, // Smaller textures for better AR performance
                        truncateDrawRange: true,
                        includeCustomExtensions: false,
                        forcePowerOfTwoTextures: true
                    },
                    (error) => reject(error)
                );
            });
            
            const blob = new Blob([gltf], { type: 'model/gltf-binary' });
            const url = URL.createObjectURL(blob);
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Set up model with AR-optimized attributes
            modelViewer.src = url;
            modelViewer.setAttribute('ios-src', url);
            modelViewer.setAttribute('ar-scale', 'auto'); // Let AR adjust scale
            modelViewer.setAttribute('ar-placement', 'floor');
            
            // Wait for model to load before declaring success
            await new Promise((resolve) => {
                const onLoad = () => {
                    modelViewer.removeEventListener('load', onLoad);
                    resolve();
                };
                modelViewer.addEventListener('load', onLoad);
                
                // Fallback timeout
                setTimeout(resolve, 5000);
            });
            
            addStatus('‚úÖ AR-optimized cabinet model loaded!', 'success');
            addStatus('üì± Model is ready for AR - tap "View in Your Space"', 'info');
            
            // Enable manual AR button
            const manualBtn = document.getElementById('manual-ar-btn');
            if (manualBtn) manualBtn.disabled = false;
        }
        
        async function loadFallbackModel() {
            // Use a publicly available test model for fallback
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Google's Astronaut model (known to work well with AR)
            const fallbackUrl = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
            
            try {
                modelViewer.src = fallbackUrl;
                modelViewer.setAttribute('ios-src', fallbackUrl);
                
                addStatus('‚úÖ Fallback model loaded (Google Astronaut)', 'success');
                addStatus('üì± You can test AR with this model', 'info');
                
                // Enable manual AR button
                const manualBtn = document.getElementById('manual-ar-btn');
                if (manualBtn) manualBtn.disabled = false;
            } catch (error) {
                addStatus('‚ùå Even fallback model failed to load', 'error');
            }
        }
        
        async function loadGoogleModel() {
            addStatus('Loading Google test model (known to work well)...', 'info');
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Use Google's well-tested Astronaut model
            const modelUrl = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
            
            try {
                modelViewer.src = modelUrl;
                modelViewer.setAttribute('ios-src', modelUrl);
                
                addStatus('‚úÖ Google test model loaded successfully!', 'success');
                addStatus('üì± This model is AR-optimized and should work reliably', 'info');
                
                // Enable manual AR button
                const manualBtn = document.getElementById('manual-ar-btn');
                if (manualBtn) manualBtn.disabled = false;
                
            } catch (error) {
                addStatus('‚ùå Failed to load Google model: ' + error.message, 'error');
            }
        }
        
        // Initialize model-viewer event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Enhanced AR status tracking
            modelViewer.addEventListener('ar-status', (event) => {
                const status = event.detail.status;
                console.log('AR Status change:', status);
                
                if (status === 'session-started') {
                    addStatus('üéâ AR session started! Look around for placement indicators.', 'success');
                } else if (status === 'not-presenting') {
                    addStatus('üì± AR session ended normally', 'info');
                } else if (status === 'failed') {
                    addStatus('‚ùå AR session failed to start - try again', 'error');
                    handleARFailure();
                } else if (status === 'session-initialized') {
                    addStatus('üîÑ AR session initializing...', 'info');
                }
            });
            
            // Enhanced error handling
            modelViewer.addEventListener('error', (event) => {
                console.error('Model Viewer Error:', event.detail);
                addStatus('‚ùå Model error: ' + (event.detail.message || 'Unknown error'), 'error');
                handleARFailure();
            });
            
            // Model loading events
            modelViewer.addEventListener('load', () => {
                addStatus('‚úÖ Model loaded and ready for AR', 'success');
                console.log('Model loaded successfully');
            });
            
            modelViewer.addEventListener('preload', () => {
                addStatus('üîÑ Model preloading...', 'info');
            });
            
            // AR tracking events (more detailed)
            modelViewer.addEventListener('ar-tracking', (event) => {
                const trackingStatus = event.detail.status;
                console.log('AR Tracking:', trackingStatus);
                
                if (trackingStatus === 'tracking') {
                    addStatus('üìç AR tracking active - surface detected', 'success');
                } else if (trackingStatus === 'not-tracking') {
                    addStatus('üîç Looking for surfaces... move your device slowly', 'info');
                }
            });
            
            // Handle camera errors specifically
            modelViewer.addEventListener('camera-change', (event) => {
                console.log('Camera change:', event.detail);
            });
            
            // Additional safety: catch unhandled promise rejections
            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                if (event.reason && event.reason.toString().includes('AR')) {
                    addStatus('‚ùå AR error detected: ' + event.reason.toString(), 'error');
                    handleARFailure();
                    event.preventDefault(); // Prevent default error handling
                }
            });
        });
        
        function handleARFailure() {
            addStatus('üîß Attempting to recover from AR failure...', 'info');
            
            const modelViewer = document.getElementById('ar-test-viewer');
            
            // Try to reset the model-viewer
            setTimeout(() => {
                try {
                    // Clear and reload the model
                    const currentSrc = modelViewer.src;
                    modelViewer.src = '';
                    
                    setTimeout(() => {
                        modelViewer.src = currentSrc;
                        addStatus('üîÑ Model reloaded - you can try AR again', 'info');
                    }, 1000);
                    
                } catch (error) {
                    console.error('Recovery failed:', error);
                    addStatus('‚ùå Recovery failed - try refreshing the page', 'error');
                }
            }, 2000);
        }
    </script>
    
    <!-- Load Three.js for model creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
</body>
</html>
